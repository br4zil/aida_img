{% extends 'galeria/base.html' %}

{% load static %}
{% block content %}

<style>
  .loading-icon {
    width: 20px;
    height: 20px;
    border: 3px solid #ccc;
    border-radius: 50%;
    border-top-color: #333;
    animation: spin 1s linear infinite;
    margin-right: 10px;
    display: inline-block;
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  
  .progress-bar-container {
    width: 100%;
    height: 30px;
    background-color: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
    display: inline-block;
    align-items: center; /* Centraliza o ícone de carregamento verticalmente */
  }
  
  .progress-bar {
    width: 0%;
    height: 100%;
    background-color: #4caf50;
    transition: width 2s, background-color 2s;
  }
  
  
  
  
  
  


  
</style>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
</script>


              <div class="card shadow-sm">  
                <div class="card-body">
                <label for=""><h6>Curso</h6></label>
                <h5> {{ curso.0.nome }}  </h5>
              </div>
              </div>


              <p>&nbsp;</p>
              
              {% if imagens_curso %}
              
              
              <div class="card shadow-sm">  
                <div class="card-body">
                <label for=""><h6>Resumo do Curso</h6></label>
                
                <div class="row">
                  <div class="col-md-3">
                    
                    <div>Total de imagens: {{dados_curso.total}}</div>
                    <div>Total de Normal: {{dados_curso.total_normal}} ({{dados_curso.porc_normal}}%)</div>
                    <div>Total de IDA: {{dados_curso.total_ida}} ({{dados_curso.porc_ida}}%)</div>
                    <div>Total de Cópia: {{dados_curso.total_ida_mono}}</div>
                    <div>Total de Mono: {{dados_curso.total_ida_mono}}</div>
                  </div>
                  <div class="col-md-4">
                    <canvas id="myChart1" style="width:100%;max-width:600px"></canvas>
                  </div>
                  <div class="col-md-4">
                    <canvas id="myChart2" style="width:100%;max-width:600px"></canvas>
                  </div>
              </div>
              </div>
            </div>
              <p>&nbsp;</p>



              {% endif %}
              <div class="card shadow-sm">
                <div class="card-body">
              <h6>Opções</h6>
              <a class="btn btn-secondary" href="{% url 'cursos' %}">Voltar</a>
              <a class="btn btn-success" href="{%url 'galeria-upload' %}">Enviar imagens...</a>    
              {% comment %} <a class="btn btn-danger" href="{%url 'galeria-imagem-delete-all' %}">Excluir todas as imagens</a>     {% endcomment %}
              <a id="btn_analisarIDA" href="" class="btn btn-success">Analisar IDA</a> <div class="loading-icon" id="divloadicon" style="display: none"></div>
              
              <div id="progresso-analisarIDA" class="text-success"></div>
              <div class="progress-container" style="display: none">
             
                <div class="progress-bar-container">
                  <div class="progress-bar" id="progress-bar"></div>
                </div>
              
            
              </div>      
            </div>
            </div>   

            

              <p>&nbsp;</p>
              <div class="card shadow-sm">
                <div class="card-body">

                <label for=""><h6> Imagens do Curso</h6></label>
              
              
              {% if not imagens_curso %}
                  <p>Não há imagens para este curso.</p>
              {% else %}
              <div class="album py-5 bg-body-tertiary">
                <div class="container">
                  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-5 g-5">
                  
                  {% for imagem_curso in imagens_curso %}
                    <div class="col">
                      <div class="card shadow-sm">
                          <title></title>
                          {% comment %} <rect width="100%" height="100%" fill="#55595c"/> {% endcomment %}
                          <small><small class="d-flex justify-content-center" title="{{ imagem_curso.nome_arquivo }}">
                            <b>{{ imagem_curso.id }}</b> - 
                            {% if imagem_curso.nome_arquivo|length > 20 %}
                                {{ imagem_curso.nome_arquivo|slice:":20" }}...
                            {% else %}
                                {{ imagem_curso.nome_arquivo }}
                            {% endif %}
                        </small></small>
                        
                          <img src="{{imagem_curso.imagem.url}}" class="img-thumbnail" alt="..." title="{{ imagem_curso.nome_arquivo }}">
                          <div class="row">
                            <div class="col-md-1">
                          {% if imagem_curso.class_sis == 'Normal' %}
                          <span class="badge rounded-pill bg-success">{{imagem_curso.class_sis}}</span>
                          {% endif %}
                          {% if imagem_curso.class_sis == 'None' %}
                          <span class="badge rounded-pill bg-secondary">{{imagem_curso.class_sis}}</span>
                          {% endif %}
                          {% if imagem_curso.class_sis == 'IDA Mono' or imagem_curso.class_sis == 'IDA Cópia' %}
                            <span class="badge rounded-pill bg-danger">{{imagem_curso.class_sis}}</span>
                          {% endif %}
                        </div>
                        </div>
                          {% comment %} <text x="50%" y="50%" fill="#eceeef" dy=".3em">{{ imagem_curso.nome_arquivo }}</text> {% endcomment %}
                        <div class="card-body">
                          {% comment %} <p class="card-text"></p> {% endcomment %}
                          <div class="d-flex justify-content-end">
                            <div class="btn-group">
                              {% comment %} <button type="button" class="btn btn-sm btn-outline-secondary">Ver</button> {% endcomment %}
                              
                              <a href="/galeria-imagem-delete/{{ imagem_curso.id }}" class="btn btn-sm btn-outline-danger">Excluir</a>
                            </div>
                            {% comment %} <small class="text-body-secondary"></small> {% endcomment %}
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                  </div>
                </div>
                {% endif %}                  
              </div>
                </div>

                {% comment %} <script>
                  var socket = new WebSocket("ws://{{ request.get_host }}/progress/");

                  socket.onmessage = function(event) {
                      var data = JSON.parse(event.data);
                      console.log(data.message);
                  };

                  socket.onclose = function(event) {
                      console.log("Conexão fechada.");
                  };
                </script> {% endcomment %}


                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script>
                  $(document).ready(function() {
                    // Função para enviar uma mensagem para iniciar a tarefa
                    $('#btn_analisarIDA').click(function(e) {
                        e.preventDefault(); // Previne o comportamento padrão do link
                        if (window.location.protocol === "https:") {
                          var socket = new WebSocket("wss://{{ request.get_host }}/progress/{{ curso.0.id }}/");
                        } else {
                          var socket = new WebSocket("ws://{{ request.get_host }}/progress/{{ curso.0.id }}/");
                        }
                        socket.onmessage = function(event) {
                          var data = JSON.parse(event.data);
                          $('.progress-container').css('display','block');
                          $('#divloadicon').css('display','inline-block');
                          console.log(event.data);
                          if(data.message=="Fim") {
                            var progressContainer = document.querySelector('.progress-container');
                            progressContainer.style.display = 'none';
                            // Redirecionar para uma URL específica
                            window.location.href = "http://{{ request.get_host }}/galeria-identificarIDA";

                            socket.disconnect();
                          } else {
                            $('#progresso-analisarIDA').text("Aguarde.. analisando imagens: "+data.message);
                            let vetor = data.message.split(" ");
                            let porcentagem = vetor[0]/vetor[2]*100;
                            updateProgressBar(porcentagem)
                          }
                        };
                        socket.onclose = function(event) {
                          //$('#progresso-analisarIDA').text(data.message);
                        };

                      function updateProgressBar(newPercentage) {
                        var progressBarContainer = document.querySelector('.progress-bar-container');
                        var progressBar = document.getElementById('progress-bar');
                      
                        var currentPercentage = parseFloat(progressBar.style.width) || 0;
                        var totalPercentage = currentPercentage + newPercentage;
                      
                        if (totalPercentage > 100) {
                          totalPercentage = 100;
                        }
                      
                        var animationDuration = 3000; // 2000 milissegundos = 2 segundos
                        var startTime = performance.now();
                      
                        function animateWidth() {
                          var currentTime = performance.now();
                          var elapsed = currentTime - startTime;
                          var progress = elapsed / animationDuration;
                      
                          if (progress > 1) {
                            progress = 1;
                          }
                      
                          progressBar.style.width = (currentPercentage + (totalPercentage - currentPercentage) * progress) + '%';
                      
                          if (progress < 1) {
                            requestAnimationFrame(animateWidth);
                          } else {
                            // Oculta a div quando a animação estiver concluída
                            // progressBarContainer.style.display = 'none';
                          }
                        }
                      
                        animateWidth();
                      
                        //progressBarContainer.style.display = 'flex';
                      }
                      
                      function animateColor() {
                        var progressBar = document.getElementById('progress-bar');
                        var currentPercentage = parseFloat(progressBar.style.width) || 0;
                        var color = getColorForPercentage(currentPercentage);
                        progressBar.style.backgroundColor = color;
                      
                        requestAnimationFrame(animateColor);
                      }
                      
                      function getColorForPercentage(percentage) {
                        var hue = ((percentage / 100) * 120).toString(10);
                        return 'hsl(' + hue + ', 100%, 50%)';
                      }
                      
                      animateColor(); // Inicia a animação de cor
                      
                      
                      
                      
                      

                      
                      
                      
                      
                      
    
                    });
                });
                
              </script>


              <script>
                const xValues = ["Normal", "IDA"];
                const yValues = [{{dados_curso.total_normal}}, {{dados_curso.total_ida_copia}}+{{dados_curso.total_ida_mono}}];
                const barColors = [
                "green",
                "#b91d47",
                  
                ];
                
                new Chart("myChart1", {
                  type: "pie",
                  data: {
                    labels: xValues,
                    datasets: [{
                      backgroundColor: barColors,
                      data: yValues
                    }]
                  },
                  options: {
                    title: {
                      display: true,
                      text: "Indícios de Desonestidade Acadêmica"
                    }
                  }
                });
                </script>   
                
                <script>
                  const xValues2 = ["Normal", "Cópia", "Mono"];
                  const yValues2 = [{{dados_curso.total_normal}}, {{dados_curso.total_ida_copia}}, {{dados_curso.total_ida_mono}}];
                  const barColors2 = [
                  "green",
                  "#b91d47",
                  "#b91d99",
                    
                  ];
                  
                  new Chart("myChart2", {
                    type: "pie",
                    data: {
                      labels: xValues2,
                      datasets: [{
                        backgroundColor: barColors2,
                        data: yValues2
                      }]
                    },
                    options: {
                      title: {
                        display: true,
                        text: "Normal, Cópia e Mono"
                      }
                    }
                  });
                  </script>

              {% comment %} <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
              <script>
                let eventSource;
                const sseData = document.getElementById('sse-data');
            
                function startSSE() {
                    eventSource = new EventSource('/galeria-identificarIDA');
                    eventSource.onmessage = event => sseData.innerHTML += event.data + '<br>';
                    document.querySelector('button[onclick="startSSE()"]').disabled = true;
                    document.querySelector('button[onclick="stopSSE()"]').disabled = false;
                }
            
                function stopSSE() {
                    if (eventSource) {
                      eventSource.close();
                    }
                    document.querySelector('button[onclick="startSSE()"]').disabled = false;
                    document.querySelector('button[onclick="stopSSE()"]').disabled = true;
                }
            </script> {% endcomment %}
            
              {% comment %} <script>
                function connectToWebSocket() {
                    var socket = new WebSocket("ws://{{ request.get_host }}/progress/");
            
                    socket.onopen = function(event) {
                        console.log("Conexão WebSocket estabelecida.");
                        callDjangoView();
                    };
            
                    socket.onerror = function(error) {
                        console.error("Erro na conexão WebSocket:", error);
                    };
            
                    socket.onmessage = function(event) {
                        console.log('Mensagem recebida do WebSocket:', event.data);
                    };
                }
            
                function callDjangoView() {
                    console.log('Chamando a view do Django...');
                    fetch('/galeria-identificarIDA')
                        .then(response => response.text())
                        .then(data => console.log('Resposta da view do Django:', data))
                        .catch(error => console.error('Erro ao chamar a view do Django:', error));
                }
            
                connectToWebSocket();
            </script> {% endcomment %}
            
              


              
              {% comment %} <script>

              
                  var socket = new WebSocket("ws://{{ request.get_host }}/progress/");
                  $('#progress-text').text('Conectado');
                  socket.onmessage = function(e) {
                      console.log('teste')
                      var progress = parseInt(e.data);
                      console.log(progress)
                      // Atualize a barra de progresso na sua interface com base no valor de 'progress'
                      $('#progress-text').text('Progresso: ' + progress);
                  };
                </script> {% endcomment %}

 


{% comment %} 
$(document).ready(function() {
  $('#btn_analisarIDA').click(function() {
      $.ajax({
          url: 'galeria-identificarIDA',
          type: 'GET',
          success: function(data) {
              // Inicia a tarefa e obtém o ID da tarefa
              // var task_id = data.task_id;
              
              // Função para verificar o progresso da tarefa
              function checkProgress() {
                  $.ajax({
                      url: 'check-progres/?task_id=' + task_id,
                      type: 'GET',
                      success: function(data) {
                          if (data.state == 'SUCCESS') {
                            var progress = data.progress;
                            $('#progress-text').text('Progresso: Fim');
                          } else {
                              // Tarefa ainda em andamento, atualize a barra de progresso
                              var progress = data.progress;
                              $('#progress-text').text('Progresso: ' + progress);
                          }
                      },
                      complete: function() {
                          // Continue verificando o progresso a cada intervalo
                          setTimeout(checkProgress, 1000);
                      }
                  });
              }
              
              // Inicia a verificação do progresso da tarefa
              checkProgress();
          }
      });
  });
});
            
                          </script> {% endcomment %}
              
              
                          

{% endblock %}
